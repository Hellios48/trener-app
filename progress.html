<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π –ü—Ä–æ–≥—Ä–µ—Å—Å</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #27ae60; --bg: #f2f5f7; --card-bg: #ffffff; --text: #333; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; padding-bottom: 80px; }
        
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        
        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .stat-item { text-align: center; width: 48%; background: #f5fcf9; padding: 15px 10px; border-radius: 12px; border: 1px solid #e0f2e9; }
        .stat-val { font-size: 24px; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 13px; color: #666; margin-top: 5px; }

        .chart-container { position: relative; height: 200px; width: 100%; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-report { background: linear-gradient(90deg, #2980b9 0%, #3498db 100%); color: white; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3); }
        .btn-save { background: var(--primary); color: white; }
        .btn-cancel { background: transparent; color: #888; }
        
        .fab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; font-size: 30px; border: none; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4); z-index: 100; cursor: pointer; }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ */
        .photo-upload-container { border: 2px dashed #bdc3c7; border-radius: 12px; padding: 15px; text-align: center; margin-bottom: 15px; cursor: pointer; transition: 0.2s; }
        .photo-upload-container.has-file { border-color: var(--primary); background: #e8f8f5; }
        .photo-icon { font-size: 24px; display: block; margin-bottom: 5px; }
        .photo-text { font-size: 13px; color: #7f8c8d; }
        #fileInput { display: none; }

        /* –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ */
        select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; background: #fff; margin-bottom: 15px; font-weight: bold; color: #2c3e50; }

        /* –ú–æ–¥–∞–ª–∫–∞ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 85%; max-width: 350px; max-height: 90vh; overflow-y: auto; }
        
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; }
        
        /* –ü–æ–ª—è –∏–º–µ–Ω–∏ */
        .name-input { border: 2px solid var(--primary); background: #f0fff4; color: #000; font-weight: bold; text-align: center; margin-bottom: 10px; }
        
        .history-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; font-size: 14px; }
        .del-btn { color: #e74c3c; cursor: pointer; padding-left: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <h2 style="text-align:center; color:#2c3e50; margin: 10px 0;">–î–Ω–µ–≤–Ω–∏–∫ –£—Å–ø–µ—Ö–∞</h2>

    <div class="card" id="nameCard">
        <label>–¢–≤–æ—è –§–∞–º–∏–ª–∏—è</label>
        <input type="text" id="userSurname" class="name-input" placeholder="–ò–≤–∞–Ω–æ–≤–∞" onchange="checkName()">
        
        <label>–¢–≤–æ–µ –ò–º—è</label>
        <input type="text" id="userName" class="name-input" placeholder="–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞" onchange="checkName()">
        
        <button id="saveNameBtn" class="btn btn-save" onclick="saveNameManual()" style="display:none;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <p style="font-size:12px; color:#888; margin:10px 0 0 0; text-align:center;">–í–≤–µ–¥–∏ –æ–¥–∏–Ω —Ä–∞–∑, —è –∑–∞–ø–æ–º–Ω—é</p>
    </div>

    <div class="stats-row">
        <div class="stat-item">
            <div id="totalLost" class="stat-val">0</div>
            <div class="stat-label">–°–±—Ä–æ—à–µ–Ω–æ (–∫–≥)</div>
        </div>
        <div class="stat-item">
            <div id="currentWeight" class="stat-val">--</div>
            <div class="stat-label">–¢–µ–∫—É—â–∏–π –≤–µ—Å</div>
        </div>
    </div>

    <div class="card">
        <div class="chart-container">
            <canvas id="progressChart"></canvas>
        </div>
    </div>

    <div class="card" style="text-align: center;">
        <h3 style="margin-top:0;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç</h3>
        
        <label style="text-align:left;">–¢–∏–ø –æ—Ç—á–µ—Ç–∞:</label>
        <select id="reportType">
            <option value="–ü—è—Ç–Ω–∏—á–Ω—ã–π –æ—Ç—á–µ—Ç">üìÖ –ü—è—Ç–Ω–∏—á–Ω—ã–π –æ—Ç—á–µ—Ç</option>
            <option value="–°–¢–ê–†–¢ –°–ï–ó–û–ù–ê">üöÄ –°–¢–ê–†–¢ –°–ï–ó–û–ù–ê (–§–æ—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</option>
            <option value="–§–ò–ù–ê–õ –°–ï–ó–û–ù–ê">üèÅ –§–ò–ù–ê–õ –°–ï–ó–û–ù–ê</option>
        </select>

        <label for="fileInput" class="photo-upload-container" id="photoLabel">
            <span class="photo-icon">üì∏</span>
            <span class="photo-text" id="photoText">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –≤–µ—Å–æ–≤ / —Ñ–æ—Ä–º—ã</span>
        </label>
        <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect()">

        <button id="sendBtn" class="btn btn-report" onclick="sendReport()">
            ‚òÅÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É
        </button>
        <p style="font-size:12px; color:#999; margin-top:10px;">–î–ª—è —Å—Ç–∞—Ä—Ç–∞: —Ñ–æ—Ç–æ –Ω–∞ –≤–µ—Å–∞—Ö + —Ñ–æ—Ç–æ –≤ –∑–µ—Ä–∫–∞–ª–µ (–ø–æ –∂–µ–ª–∞–Ω–∏—é)</p>
    </div>

    <div class="card">
        <h3 style="margin-top:0;">–ò—Å—Ç–æ—Ä–∏—è</h3>
        <div id="historyList"></div>
    </div>

    <button class="fab" onclick="openModal()">+</button>

    <div id="entryModal" class="modal">
        <div class="modal-content">
            <h3 style="text-align:center; margin-top:0;">–ù–æ–≤—ã–π –∑–∞–º–µ—Ä</h3>
            <label>–î–∞—Ç–∞</label>
            <input type="date" id="inpDate">
            
            <label>–í–µ—Å (–∫–≥)*</label>
            <input type="number" id="inpWeight" step="0.1">
            
            <label>–û–±—Ö–≤–∞—Ç –≥—Ä—É–¥–∏ (—Å–º)</label>
            <input type="number" id="inpChest">

            <label>–û–±—Ö–≤–∞—Ç —Ç–∞–ª–∏–∏ (—Å–º)</label>
            <input type="number" id="inpWaist">
            
            <label>–û–±—Ö–≤–∞—Ç –±–µ–¥–µ—Ä (—Å–º)</label>
            <input type="number" id="inpHips">

            <button class="btn btn-save" onclick="saveEntry()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-cancel" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // -----------------------------------------------------------
        // –í–°–¢–ê–í–¨ –°–í–û–Æ –°–°–´–õ–ö–£ –ù–ò–ñ–ï (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)
        const SCRIPT_URL = "–í–°–¢–ê–í–¨_–°–Æ–î–ê_–°–í–û–Æ_–°–°–´–õ–ö–£_EXEC"; 
        // -----------------------------------------------------------

        let entries = JSON.parse(localStorage.getItem('leonov_progress')) || [];
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é –æ—Ç–¥–µ–ª—å–Ω–æ
        let savedName = localStorage.getItem('leonov_firstname') || "";
        let savedSurname = localStorage.getItem('leonov_surname') || "";
        
        let chartInstance = null;
        let selectedImageBase64 = null;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('inpDate').valueAsDate = new Date();
            
            // –ï—Å–ª–∏ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã - —Å–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫
            if(savedName && savedSurname) {
                document.getElementById('userName').value = savedName;
                document.getElementById('userSurname').value = savedSurname;
                document.getElementById('nameCard').style.display = 'none';
            }
            updateUI();
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–µ–π –∏–º–µ–Ω–∏ –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
        function checkName() {
            const name = document.getElementById('userName').value;
            const surname = document.getElementById('userSurname').value;
            if (name && surname) {
                document.getElementById('saveNameBtn').style.display = 'block';
            }
        }

        // –†—É—á–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–º–µ–Ω–∏ (–ø–æ –∫–Ω–æ–ø–∫–µ)
        function saveNameManual() {
            const name = document.getElementById('userName').value.trim();
            const surname = document.getElementById('userSurname').value.trim();
            
            if(name && surname) {
                localStorage.setItem('leonov_firstname', name);
                localStorage.setItem('leonov_surname', surname);
                savedName = name;
                savedSurname = surname;
                document.getElementById('nameCard').style.display = 'none';
            } else {
                alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ò–º—è –∏ –§–∞–º–∏–ª–∏—é!");
            }
        }

        function updateUI() {
            entries.sort((a, b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem('leonov_progress', JSON.stringify(entries));
            calculateStats();
            renderChart();
            renderHistory();
        }

        function calculateStats() {
            if (entries.length === 0) {
                document.getElementById('currentWeight').innerText = "--";
                document.getElementById('totalLost').innerText = "0";
                return;
            }
            const start = entries[0].weight;
            const current = entries[entries.length - 1].weight;
            const diff = (start - current).toFixed(1);
            document.getElementById('currentWeight').innerText = current + " –∫–≥";
            const diffEl = document.getElementById('totalLost');
            
            if (diff > 0) { diffEl.innerText = "-" + diff; diffEl.style.color = "#27ae60"; } 
            else if (diff < 0) { diffEl.innerText = "+" + Math.abs(diff); diffEl.style.color = "#c0392b"; } 
            else { diffEl.innerText = "0"; diffEl.style.color = "#333"; }
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = "";
            [...entries].reverse().forEach((entry, index) => {
                const realIndex = entries.length - 1 - index;
                const dateStr = new Date(entry.date).toLocaleDateString('ru-RU', {day: 'numeric', month: 'long'});
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `<div><b>${dateStr}</b></div><div>${entry.weight} –∫–≥</div><div class="del-btn" onclick="deleteEntry(${realIndex})">‚úï</div>`;
                list.appendChild(div);
            });
        }

        function renderChart() {
            const ctx = document.getElementById('progressChart').getContext('2d');
            const dates = entries.map(e => new Date(e.date).toLocaleDateString('ru-RU', {day: '2-digit', month: '2-digit'}));
            const weights = entries.map(e => e.weight);

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: '–í–µ—Å', data: weights, borderColor: '#27ae60', backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        borderWidth: 3, tension: 0.4, pointRadius: 4, fill: true
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grace: '5%' } } }
            });
        }

        function openModal() { document.getElementById('entryModal').classList.add('active'); }
        function closeModal() { document.getElementById('entryModal').classList.remove('active'); }

        function saveEntry() {
            const date = document.getElementById('inpDate').value;
            const weight = parseFloat(document.getElementById('inpWeight').value);
            const chest = document.getElementById('inpChest').value;
            const waist = document.getElementById('inpWaist').value;
            const hips = document.getElementById('inpHips').value;

            if (!date || !weight) { alert("–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –∏ –≤–µ—Å!"); return; }

            const newEntry = { date, weight, chest, waist, hips };
            const existingIndex = entries.findIndex(e => e.date === date);
            if (existingIndex >= 0) { entries[existingIndex] = newEntry; } 
            else { entries.push(newEntry); }

            closeModal();
            updateUI();
            
            document.getElementById('inpWeight').value = "";
            document.getElementById('inpChest').value = "";
            document.getElementById('inpWaist').value = "";
            document.getElementById('inpHips').value = "";
        }

        function deleteEntry(index) {
            if(confirm("–£–¥–∞–ª–∏—Ç—å?")) { entries.splice(index, 1); updateUI(); }
        }

        function handleFileSelect() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }

                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    selectedImageBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    
                    document.getElementById('photoLabel').classList.add('has-file');
                    document.getElementById('photoText').innerText = "–§–æ—Ç–æ –≥–æ—Ç–æ–≤–æ ‚úÖ";
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        }

        function sendReport() {
            if (entries.length === 0) { alert("–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å –∑–∞–º–µ—Ä (–∫–Ω–æ–ø–∫–∞ +)!"); return; }
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—É—Å—Ç—ã, –ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∏–∑ –ø–æ–ª–µ–π
            if (!savedName || !savedSurname) {
                savedName = document.getElementById('userName').value.trim();
                savedSurname = document.getElementById('userSurname').value.trim();
            }

            if (!savedName || !savedSurname) { 
                document.getElementById('nameCard').style.display = 'block';
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏ –ò–º—è –∏ –§–∞–º–∏–ª–∏—é —Å–≤–µ—Ä—Ö—É!"); 
                window.scrollTo(0,0); 
                return; 
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–µ –±—ã–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
            localStorage.setItem('leonov_firstname', savedName);
            localStorage.setItem('leonov_surname', savedSurname);

            // –§–û–†–ú–ò–†–£–ï–ú –ü–û–õ–ù–û–ï –ò–ú–Ø
            const fullName = savedSurname + " " + savedName; // –ò–≤–∞–Ω–æ–≤–∞ –ï–∫–∞—Ç–µ—Ä–∏–Ω–∞

            const reportType = document.getElementById('reportType').value;
            if (reportType === "–°–¢–ê–†–¢ –°–ï–ó–û–ù–ê" && !selectedImageBase64) {
                alert("‚ùó –î–ª—è –°–¢–ê–†–¢–ê –°–ï–ó–û–ù–ê —Ñ–æ—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!");
                return;
            }

            const btn = document.getElementById('sendBtn');
            btn.innerText = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...";
            btn.disabled = true;

            const lastEntry = entries[entries.length - 1];

            const payload = {
                name: fullName, // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∫–ª–µ–µ–Ω–Ω–æ–µ –∏–º—è
                reportType: reportType,
                weight: lastEntry.weight,
                chest: lastEntry.chest || "-",
                waist: lastEntry.waist || "-",
                hips: lastEntry.hips || "-",
                image: selectedImageBase64 || ""
            };

            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(payload)
            })
            .then(() => {
                alert("‚úÖ –û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! " + reportType);
                selectedImageBase64 = null;
                document.getElementById('photoLabel').classList.remove('has-file');
                document.getElementById('photoText').innerText = "–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ";
                document.getElementById('fileInput').value = "";
                btn.innerText = "‚òÅÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É";
                btn.disabled = false;
            })
            .catch(err => {
                alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏.");
                btn.innerText = "‚òÅÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É";
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>
